#!/bin/bash
###############################################################
# ðŸ”¥ Pannel Server CentOS 7 Installer + phpMyAdmin + TinyFileManager + HTTPS
# âœ… PHP 8.0 + MariaDB 10.5 + Nginx + phpMyAdmin + TinyFileManager
# ðŸ‘‘ Copyright (C) 2025 Viá»‡t_Anh_Codeâ„¢
###############################################################

set -e

# ===== Cyberpunk Logo =====
logo() {
echo -e "\e[5;38;5;45m     ____  _   _  _____ _   _  _   _   ____  _   _  ____  \e[0m"
echo -e "\e[5;38;5;213m    |  _ \\| \\ | || ____| \\ | || \\ | | / ___|| | | |/ ___| \e[0m"
echo -e "\e[5;38;5;45m    | |_) |  \\| ||  _| |  \\| ||  \\| | \\___ \\| | | | |  _   \e[0m"
echo -e "\e[5;38;5;213m    |  __/| |\\  || |___| |\\  || |\\  |  ___) | |_| | |_| |  \e[0m"
echo -e "\e[5;38;5;201m    |_|   |_| \\_||_____|_| \\_||_| \\_| |____/ \\___/ \\____|  \e[0m"
echo -e "\e[5;38;5;45m          ðŸ‘‘ Viá»‡t_Anh_Codeâ„¢ 2025 | Cyberpunk Safe V2 + HTTPS\e[0m"
}

clear
logo
echo "ðŸš€ Báº¯t Ä‘áº§u cÃ i Ä‘áº·t Pannel Server CentOS 7..."
echo "--------------------------------------------------"

# Kiá»ƒm tra root
if [ $(id -u) != "0" ]; then
  echo "âŒ Cáº§n cháº¡y báº±ng quyá»n root!"
  exit 1
fi

# Nháº­p domain + port vá»›i validate
while true; do
    read -p "Nháº­p domain quáº£n trá»‹ server (VD: domain.com hoáº·c Ä‘á»ƒ trá»‘ng dÃ¹ng IP): " ADMIN_DOMAIN
    if [[ -z "$ADMIN_DOMAIN" ]] || [[ "$ADMIN_DOMAIN" =~ ^[a-zA-Z0-9.-]+$ ]]; then
        break
    else
        echo "âŒ Domain khÃ´ng há»£p lá»‡, thá»­ láº¡i!"
    fi
done

while true; do
    read -p "Nháº­p port quáº£n trá»‹ server (VD: 2025): " ADMIN_PORT
    if [[ "$ADMIN_PORT" =~ ^[0-9]+$ ]] && [ "$ADMIN_PORT" -ge 1 ] && [ "$ADMIN_PORT" -le 65535 ]; then
        break
    else
        echo "âŒ Port khÃ´ng há»£p lá»‡, thá»­ láº¡i!"
    fi
done

# ===== Táº¡o random password =====
PANEL_DB="panel_db"
PANEL_USER="panel_user"
PANEL_PASS=$(openssl rand -base64 12)  # ~16 kÃ½ tá»±
WEB_ADMIN_PASS=$(openssl rand -base64 12)  # ~16 kÃ½ tá»±
MYSQL_ROOT_PASS=$(openssl rand -base64 16)  # root password random

# ===== Fix repo CentOS 7 Vault =====
sed -i 's/enabled=1/enabled=0/g' /etc/yum.repos.d/CentOS-*.repo || true
cat > /etc/yum.repos.d/CentOS-Archive.repo <<EOF
[base]
name=CentOS-7 - Base - Archive
baseurl=http://vault.centos.org/7.9.2009/os/x86_64/
gpgcheck=0
enabled=1
[updates]
name=CentOS-7 - Updates - Archive
baseurl=http://vault.centos.org/7.9.2009/updates/x86_64/
gpgcheck=0
enabled=1
[extras]
name=CentOS-7 - Extras - Archive
baseurl=http://vault.centos.org/7.9.2009/extras/x86_64/
gpgcheck=0
enabled=1
EOF
yum clean all
yum makecache


# ===== Firewall =====
systemctl start --now firewalld
systemctl enable --now firewalld

# ===== Cáº­p nháº­t & cÃ i gÃ³i cÆ¡ báº£n =====
yum update -y
yum install -y wget nano curl epel-release yum-utils unzip policycoreutils-python

# ===== SSH setup =====
SSH_PORT=2222
if ! grep -q "^Port $SSH_PORT" /etc/ssh/sshd_config; then
    sed -i "/^Port /d" /etc/ssh/sshd_config
    echo "Port $SSH_PORT" >> /etc/ssh/sshd_config
fi
sshd -t && systemctl restart sshd
firewall-cmd --permanent --add-port=$SSH_PORT/tcp
firewall-cmd --reload

# ===== SELinux & DNS =====
cp /etc/selinux/config /etc/selinux/config.bak
setenforce 0
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config

cp /etc/resolv.conf /etc/resolv.conf.bak
grep -q "nameserver 8.8.8.8" /etc/resolv.conf || echo "nameserver 8.8.8.8" >> /etc/resolv.conf

# ===== PHP 8.0 =====
yum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm
yum-config-manager --enable remi-php80
yum install -y php php-cli php-fpm php-mysqlnd php-mbstring php-xml php-gd php-curl

# ===== Remove old MariaDB =====
systemctl stop mariadb 2>/dev/null || true
yum remove -y MariaDB* mariadb* || true
rm -rf /var/lib/mysql /etc/my.cnf* /etc/yum.repos.d/MariaDB.repo

# ===== MariaDB repo 10.5 =====
cat > /etc/yum.repos.d/MariaDB.repo <<EOF
[mariadb]
name = MariaDB
baseurl = https://archive.mariadb.org/mariadb-10.5/yum/centos7-amd64
gpgcheck = 0
EOF
yum clean all
yum makecache
yum install -y MariaDB-server MariaDB-client

# ===== Nginx =====
yum install -y nginx
systemctl enable nginx php-fpm mariadb
systemctl start nginx php-fpm mariadb

# ===== MariaDB setup =====
mysql -u root <<EOF
ALTER USER 'root'@'localhost' IDENTIFIED BY '${MYSQL_ROOT_PASS}';
FLUSH PRIVILEGES;
CREATE DATABASE IF NOT EXISTS ${PANEL_DB};
CREATE USER IF NOT EXISTS '${PANEL_USER}'@'localhost' IDENTIFIED BY '${PANEL_PASS}';
GRANT ALL PRIVILEGES ON ${PANEL_DB}.* TO '${PANEL_USER}'@'localhost';
FLUSH PRIVILEGES;
EOF

# ===== phpMyAdmin =====
mkdir -p /var/www/html/phpmyadmin
wget -O /tmp/phpmyadmin.zip https://files.phpmyadmin.net/phpMyAdmin/5.2.1/phpMyAdmin-5.2.1-all-languages.zip
unzip /tmp/phpmyadmin.zip -d /var/www/html/phpmyadmin/
mv /var/www/html/phpmyadmin/phpMyAdmin-5.2.1-all-languages/* /var/www/html/phpmyadmin/
rm -rf /var/www/html/phpmyadmin/phpMyAdmin-5.2.1-all-languages /tmp/phpmyadmin.zip
chown -R nginx:nginx /var/www/html/phpmyadmin
chmod -R 755 /var/www/html/phpmyadmin

# ===== TinyFileManager + admin random =====
mkdir -p /var/www/html/filemanager
wget -O /var/www/html/filemanager/index.php https://github.com/prasathmani/tinyfilemanager/releases/download/2.4.13/tinyfilemanager.php

TINYFM_CONFIG="/var/www/html/filemanager/tfm-config.php"
cat > $TINYFM_CONFIG <<EOF
<?php
\$username = 'admin';
\$password = '$WEB_ADMIN_PASS';
\$salt = '';
\$upload_dir = __DIR__;
?>
EOF

chown -R nginx:nginx /var/www/html/filemanager
chmod -R 755 /var/www/html/filemanager

# ===== Nginx config panel =====
NGINX_CONF="/etc/nginx/conf.d/panel.conf"
[ -f "$NGINX_CONF" ] && cp "$NGINX_CONF" "${NGINX_CONF}.bak"

if ss -tuln | awk '{print $4}' | grep -Eq "(:|\\.)${ADMIN_PORT}$"; then
    echo "âŒ Port ${ADMIN_PORT} Ä‘ang bá»‹ chiáº¿m, Ä‘á»•i port khÃ¡c!"
    exit 1
fi

# detect php-fpm socket
PHP_FPM_SOCK="/var/run/php-fpm/www.sock"
if [ ! -S "$PHP_FPM_SOCK" ]; then
    PHP_FPM_SOCK="/run/php-fpm/www.sock"
fi

cat > "$NGINX_CONF" <<EOF
server {
    listen ${ADMIN_PORT};
    server_name ${ADMIN_DOMAIN:-_};
    root /var/www/html;
    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~ \.php\$ {
        include fastcgi_params;
        fastcgi_pass unix:${PHP_FPM_SOCK};
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
}
EOF

rm -f /var/run/nginx.pid
chown -R nginx:nginx /var/www/html
chmod -R 755 /var/www/html
nginx -t && systemctl restart nginx

firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=${ADMIN_PORT}/tcp
firewall-cmd --reload

# ===== Auto SSL Letâ€™s Encrypt =====
if [ -n "$ADMIN_DOMAIN" ]; then
  echo "ðŸ” CÃ i Letâ€™s Encrypt SSL cho ${ADMIN_DOMAIN}..."
  yum install -y epel-release
  yum install -y certbot python3-certbot-nginx

  certbot --nginx -d $ADMIN_DOMAIN --non-interactive --agree-tos -m admin@$ADMIN_DOMAIN --redirect
  systemctl reload nginx
  echo "âœ… SSL Ä‘Ã£ cÃ i xong, tá»± Ä‘á»™ng redirect HTTP â†’ HTTPS"
else
  echo "âš ï¸ KhÃ´ng nháº­p domain, bá» qua SSL Letâ€™s Encrypt"
fi

# ===== Backup config + log credentials =====
BACKUP_DIR="/root/panel_install_backup"
mkdir -p "$BACKUP_DIR"
cp -f /etc/nginx/conf.d/panel.conf "$BACKUP_DIR/panel.conf.bak"
cp -f /etc/php-fpm.d/www.conf "$BACKUP_DIR/www.conf.bak" 2>/dev/null || true
cp -f /etc/my.cnf "$BACKUP_DIR/my.cnf.bak" 2>/dev/null || true
cp -f /etc/selinux/config "$BACKUP_DIR/selinux_config.bak"

CREDENTIALS_FILE="$BACKUP_DIR/panel_credentials.txt"
cat > "$CREDENTIALS_FILE" <<EOF
===== PANEL SERVER CREDENTIALS =====
Domain/IP quáº£n trá»‹: ${ADMIN_DOMAIN:-$(hostname -I | awk '{print $1}')}:${ADMIN_PORT}
Port SSH: $SSH_PORT
MySQL root password: ${MYSQL_ROOT_PASS}
Database panel: ${PANEL_DB}
DB user: ${PANEL_USER}
DB password: ${PANEL_PASS}
Web admin user: admin
Web admin password: $WEB_ADMIN_PASS
Truy cáº­p phpMyAdmin: http://${ADMIN_DOMAIN:-$(hostname -I | awk '{print $1}')}:${ADMIN_PORT}/phpmyadmin
Truy cáº­p FileManager: http://${ADMIN_DOMAIN:-$(hostname -I | awk '{print $1}')}:${ADMIN_PORT}/filemanager
EOF
chmod 600 "$CREDENTIALS_FILE"
echo "ðŸ” Táº¥t cáº£ thÃ´ng tin quan trá»ng Ä‘Ã£ Ä‘Æ°á»£c backup vÃ o: $CREDENTIALS_FILE (chá»‰ root Ä‘á»c Ä‘Æ°á»£c)"

# ===== HoÃ n táº¥t & chá» reboot =====
echo ""
echo "ðŸŽ‰ HoÃ n Táº¥t CÃ i Äáº·t Pannel Server CentOS 7 Safe V2 + HTTPS + admin random!"
echo "ThÃ´ng tin chi tiáº¿t Ä‘Ã£ backup vÃ o $CREDENTIALS_FILE"
echo ""

read -p "Nháº¥n Enter Ä‘á»ƒ reboot server hoáº·c Ctrl+C Ä‘á»ƒ há»§y..." dummy
reboot
