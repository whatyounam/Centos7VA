#!/bin/bash
###############################################################
# ðŸ”¥ Pannel Server CentOS 7 Installer + phpMyAdmin + FileManager
# âœ… PHP 8.0 + MariaDB 10.5 + Nginx + phpMyAdmin + TinyFileManager
# ðŸ‘‘ Copyright (C) 2025 Viá»‡t_Anh_Codeâ„¢
###############################################################

set -e

# ========== Cyberpunk Logo ==========
logo() {
cat <<'LOGO'
[38;5;45m     ____  _   _  _____ _   _  _   _   ____  _   _  ____  [0m
[38;5;213m    |  _ \| \ | || ____| \ | || \ | | / ___|| | | |/ ___| [0m
[38;5;45m    | |_) |  \| ||  _| |  \| ||  \| | \___ \| | | | |  _   [0m
[38;5;213m    |  __/| |\  || |___| |\  || |\  |  ___) | |_| | |_| | [0m
[38;5;201m    |_|   |_| \_||_____|_| \_||_| \_| |____/ \___/ \____| [0m
[0m
LOGO
}
clear
logo
echo "ðŸš€ Báº¯t Ä‘áº§u cÃ i Ä‘áº·t Pannel Server CentOS 7..."
echo "--------------------------------------------------"

# Kiá»ƒm tra quyá»n root
if [ $(id -u) != "0" ]; then
  echo "âŒ Cáº§n cháº¡y báº±ng quyá»n root!"
  exit 1
fi

# Nháº­p thÃ´ng tin
read -p "Nháº­p domain quáº£n trá»‹ server (VD: domain.com): " ADMIN_DOMAIN
read -p "Nháº­p port quáº£n trá»‹ server (VD: 2025): " ADMIN_PORT
read -p "Nháº­p tÃªn database cho panel (VD: panel_db): " PANEL_DB

# Báº­t firewall
systemctl start firewalld
systemctl enable firewalld

# Cáº­p nháº­t há»‡ thá»‘ng & gÃ³i cÆ¡ báº£n
yum update -y
yum install -y wget nano curl epel-release yum-utils firewalld unzip

# ðŸ› ï¸ Fix lá»—i repo CentOS 7 (Vault Mirror)
echo "ðŸ› ï¸ Äang fix lá»—i repo CentOS 7 (Vault Mirror)..."
sed -i 's/enabled=1/enabled=0/g' /etc/yum.repos.d/CentOS-*.repo || true

cat > /etc/yum.repos.d/CentOS-Archive.repo <<EOF
[base]
name=CentOS-7 - Base - Archive
baseurl=http://vault.centos.org/7.9.2009/os/x86_64/
gpgcheck=0
enabled=1

[updates]
name=CentOS-7 - Updates - Archive
baseurl=http://vault.centos.org/7.9.2009/updates/x86_64/
gpgcheck=0
enabled=1

[extras]
name=CentOS-7 - Extras - Archive
baseurl=http://vault.centos.org/7.9.2009/extras/x86_64/
gpgcheck=0
enabled=1
EOF

yum clean all
yum makecache

# SSH config
sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config
systemctl restart sshd
firewall-cmd --permanent --add-port=2222/tcp

# Disable SELinux
chattr -i /etc/selinux/config 2>/dev/null || true
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config

# DNS fix
sed -i 's/nameserver/#nameserver/g' /etc/resolv.conf || true
echo "nameserver 8.8.8.8" >> /etc/resolv.conf

# PHP repo & install
yum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm || true
yum-config-manager --enable remi-php80
yum install -y php php-cli php-fpm php-mysqlnd php-mbstring php-xml php-gd php-curl

# Remove old MariaDB
systemctl stop mariadb 2>/dev/null || true
yum remove -y MariaDB* mariadb* || true
rm -rf /var/lib/mysql /etc/my.cnf* /etc/yum.repos.d/MariaDB.repo

# MariaDB repo
cat > /etc/yum.repos.d/MariaDB.repo <<EOF
[mariadb]
name = MariaDB
baseurl = https://archive.mariadb.org/mariadb-10.5/yum/centos7-amd64
gpgcheck = 0
EOF

yum clean all
yum makecache
yum install -y MariaDB-server MariaDB-client

# Nginx
yum install -y nginx
systemctl enable nginx php-fpm mariadb
systemctl start nginx php-fpm mariadb

# MariaDB root password & create panel DB
mysql -u root <<EOF
SET PASSWORD FOR 'root'@'localhost' = PASSWORD('Conmemi01@');
FLUSH PRIVILEGES;
CREATE DATABASE IF NOT EXISTS ${PANEL_DB};
GRANT ALL PRIVILEGES ON ${PANEL_DB}.* TO 'root'@'localhost' IDENTIFIED BY 'Conmemi01@';
FLUSH PRIVILEGES;
EOF

# phpMyAdmin
mkdir -p /var/www/html/phpmyadmin
wget -O /tmp/phpmyadmin.zip https://files.phpmyadmin.net/phpMyAdmin/5.2.1/phpMyAdmin-5.2.1-all-languages.zip
unzip /tmp/phpmyadmin.zip -d /var/www/html/phpmyadmin/
mv /var/www/html/phpmyadmin/phpMyAdmin-5.2.1-all-languages/* /var/www/html/phpmyadmin/
rm -rf /var/www/html/phpmyadmin/phpMyAdmin-5.2.1-all-languages /tmp/phpmyadmin.zip
chown -R nginx:nginx /var/www/html/phpmyadmin
chmod -R 755 /var/www/html/phpmyadmin

# TinyFileManager
mkdir -p /var/www/html/filemanager
wget -O /var/www/html/filemanager/index.php https://raw.githubusercontent.com/prasathmani/tinyfilemanager/master/tinyfilemanager.php
chown -R nginx:nginx /var/www/html/filemanager
chmod -R 755 /var/www/html/filemanager

# Nginx server block cho quáº£n trá»‹
cat > /etc/nginx/conf.d/panel.conf <<EOF
server {
    listen ${ADMIN_PORT};
    server_name ${ADMIN_DOMAIN};

    root /var/www/html;
    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~ \.php\$ {
        include fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
}
EOF

# Enable php-fpm
systemctl enable php-fpm
systemctl restart php-fpm

# Test & reload Nginx
nginx -t && systemctl restart nginx

# Open ports
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=${ADMIN_PORT}/tcp
firewall-cmd --reload

# ThÃ´ng tin hoÃ n táº¥t
echo ""
echo "ðŸŽ‰ HoÃ n Táº¥t CÃ i Äáº·t Pannel Server CentOS 7!"
echo "Domain quáº£n trá»‹: ${ADMIN_DOMAIN}:${ADMIN_PORT}"
echo "Port SSH: 2222"
echo "MySQL root password: Conmemi01@"
echo "Database panel: ${PANEL_DB}"
echo "Truy cáº­p phpMyAdmin: http://${ADMIN_DOMAIN}:${ADMIN_PORT}/phpmyadmin"
echo "Truy cáº­p FileManager: http://${ADMIN_DOMAIN}:${ADMIN_PORT}/filemanager"
echo "--------------------------------------------------"
echo "ðŸ‘‘ Viá»‡t_Anh_Codeâ„¢ 2025 | CentOS V1 Cyberpunk Edition"

echo "ðŸ•’ Server sáº½ tá»± reboot sau 10 giÃ¢y..."
sleep 10
reboot
